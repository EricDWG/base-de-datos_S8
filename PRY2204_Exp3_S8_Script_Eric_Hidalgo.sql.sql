-- PARTE 1 TABLAS

CREATE TABLE REGION (
  id_region NUMBER GENERATED BY DEFAULT AS IDENTITY,
  nombre_region VARCHAR2(50),
  CONSTRAINT pk_region PRIMARY KEY (id_region)
);

CREATE TABLE COMUNA (
  id_comuna NUMBER GENERATED BY DEFAULT AS IDENTITY,
  nombre_comuna VARCHAR2(50),
  id_region NUMBER,
  CONSTRAINT pk_comuna PRIMARY KEY (id_comuna),
  CONSTRAINT fk_comuna_region FOREIGN KEY (id_region)
  REFERENCES REGION(id_region)
);

CREATE TABLE PROVEEDOR (
  id_proveedor NUMBER GENERATED BY DEFAULT AS IDENTITY,
  nombre_proveedor VARCHAR2(50),
  rut_proveedor VARCHAR2(12),
  telefono VARCHAR2(20),
  correo VARCHAR2(50),
  direccion VARCHAR2(100),
  id_comuna NUMBER,
  CONSTRAINT pk_proveedor PRIMARY KEY (id_proveedor),
  CONSTRAINT fk_proveedor_comuna FOREIGN KEY (id_comuna)
  REFERENCES COMUNA(id_comuna)
);

CREATE TABLE CATEGORIA (
  id_categoria NUMBER GENERATED BY DEFAULT AS IDENTITY,
  nombre_categoria VARCHAR2(50),
  CONSTRAINT pk_categoria PRIMARY KEY (id_categoria)
);

CREATE TABLE MARCA (
  id_marca NUMBER GENERATED BY DEFAULT AS IDENTITY,
  nombre_marca VARCHAR2(50),
  CONSTRAINT pk_marca PRIMARY KEY (id_marca)
);

CREATE TABLE PRODUCTO (
  id_producto NUMBER GENERATED BY DEFAULT AS IDENTITY,
  nombre_producto VARCHAR2(50),
  precio NUMBER(10),
  stock NUMBER(6),
  stock_minimo NUMBER(6),
  id_categoria NUMBER,
  id_marca NUMBER,
  id_proveedor NUMBER,
  CONSTRAINT pk_producto PRIMARY KEY (id_producto),
  CONSTRAINT fk_producto_categoria FOREIGN KEY (id_categoria)
  REFERENCES CATEGORIA(id_categoria),
  CONSTRAINT fk_producto_marca FOREIGN KEY (id_marca)
  REFERENCES MARCA(id_marca),
  CONSTRAINT fk_producto_proveedor FOREIGN KEY (id_proveedor)
  REFERENCES PROVEEDOR(id_proveedor)
);

CREATE TABLE AFP (
  id_afp NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 210 INCREMENT BY 6),
  nombre_afp VARCHAR2(50),
  CONSTRAINT pk_afp PRIMARY KEY (id_afp)
);

CREATE TABLE SALUD (
  id_salud NUMBER PRIMARY KEY,
  nombre_salud VARCHAR2(50)
);

CREATE SEQUENCE seq_salud START WITH 2050 INCREMENT BY 10;

CREATE TABLE EMPLEADO (
  id_empleado NUMBER PRIMARY KEY,
  nombre VARCHAR2(30),
  apellido_paterno VARCHAR2(30),
  apellido_materno VARCHAR2(30),
  fecha_contratacion DATE,
  sueldo NUMBER(10),
  bono NUMBER(10),
  activo CHAR(1),
  tipo VARCHAR2(20),
  id_salud NUMBER,
  id_afp NUMBER,
  CONSTRAINT fk_empleado_salud FOREIGN KEY (id_salud)
  REFERENCES SALUD(id_salud),
  CONSTRAINT fk_empleado_afp FOREIGN KEY (id_afp)
  REFERENCES AFP(id_afp)
);

CREATE SEQUENCE seq_empleado START WITH 750 INCREMENT BY 3;

CREATE TABLE ADMINISTRATIVO (
  id_empleado NUMBER PRIMARY KEY,
  area VARCHAR2(20),
  CONSTRAINT fk_admin_empleado FOREIGN KEY (id_empleado)
  REFERENCES EMPLEADO(id_empleado)
);

CREATE TABLE VENDEDOR (
  id_empleado NUMBER PRIMARY KEY,
  comision NUMBER(5,2),
  CONSTRAINT fk_vendedor_empleado FOREIGN KEY (id_empleado)
  REFERENCES EMPLEADO(id_empleado)
);

CREATE TABLE MEDIO_PAGO (
  id_medio NUMBER PRIMARY KEY,
  nombre_medio VARCHAR2(30)
);

CREATE TABLE VENTA (
  id_venta NUMBER GENERATED BY DEFAULT AS IDENTITY (START WITH 5050 INCREMENT BY 3),
  fecha_venta DATE,
  total NUMBER(10),
  id_medio NUMBER,
  id_empleado NUMBER,
  CONSTRAINT pk_venta PRIMARY KEY (id_venta),
  CONSTRAINT fk_venta_medio FOREIGN KEY (id_medio)
  REFERENCES MEDIO_PAGO(id_medio),
  CONSTRAINT fk_venta_empleado FOREIGN KEY (id_empleado)
  REFERENCES EMPLEADO(id_empleado)
);

CREATE TABLE DETALLE_VENTA (
  id_detalle NUMBER GENERATED BY DEFAULT AS IDENTITY,
  id_venta NUMBER,
  id_producto NUMBER,
  cantidad NUMBER(6),
  subtotal NUMBER(10),
  CONSTRAINT pk_detalle PRIMARY KEY (id_detalle),
  CONSTRAINT fk_detalle_venta FOREIGN KEY (id_venta)
  REFERENCES VENTA(id_venta),
  CONSTRAINT fk_detalle_producto FOREIGN KEY (id_producto)
  REFERENCES PRODUCTO(id_producto)
);

-- PARTE 2 REGLAS

ALTER TABLE EMPLEADO
ADD CONSTRAINT ck_sueldo_minimo CHECK (sueldo >= 400000);

ALTER TABLE VENDEDOR
ADD CONSTRAINT ck_comision CHECK (comision BETWEEN 0 AND 0.25);

ALTER TABLE PRODUCTO
ADD CONSTRAINT ck_stock_minimo CHECK (stock_minimo >= 3);

ALTER TABLE PROVEEDOR
ADD CONSTRAINT un_correo UNIQUE (correo);

ALTER TABLE MARCA
ADD CONSTRAINT un_marca UNIQUE (nombre_marca);

ALTER TABLE DETALLE_VENTA
ADD CONSTRAINT ck_cantidad CHECK (cantidad > 0);

-- PARTE 3 POBLAMIENTO 

INSERT INTO AFP (nombre_afp) VALUES ('AFP Habitat');
INSERT INTO AFP (nombre_afp) VALUES ('AFP Cuprum');
INSERT INTO AFP (nombre_afp) VALUES ('AFP Provida');
INSERT INTO AFP (nombre_afp) VALUES ('AFP PlanVital');

INSERT INTO SALUD VALUES (2050, 'Fonasa');
INSERT INTO SALUD VALUES (2060, 'Isapre Colmena');
INSERT INTO SALUD VALUES (2070, 'Isapre Banmedica');
INSERT INTO SALUD VALUES (2080, 'Isapre Cruz Blanca');

INSERT INTO MEDIO_PAGO VALUES (11, 'Efectivo');
INSERT INTO MEDIO_PAGO VALUES (12, 'Tarjeta Debito');
INSERT INTO MEDIO_PAGO VALUES (13, 'Tarjeta Credito');
INSERT INTO MEDIO_PAGO VALUES (14, 'Cheque');

INSERT INTO REGION (nombre_region) VALUES ('Region Metropolitana');
INSERT INTO REGION (nombre_region) VALUES ('Valparaiso');
INSERT INTO REGION (nombre_region) VALUES ('Biobio');
INSERT INTO REGION (nombre_region) VALUES ('Los Lagos');

--(literalmente son los datos de las fotos de la evaluacion, no se si literalmente habia que ponerlos todos...)
INSERT INTO EMPLEADO VALUES (750, 'Marcela', 'Gonzalez', 'Perez', TO_DATE('15-03-2022','DD-MM-YYYY'), 950000, 80000, 'S', 'Administrativo', 2050, 210);
INSERT INTO EMPLEADO VALUES (753, 'Jose', 'Mu√±oz', 'Ramirez', TO_DATE('10-07-2023','DD-MM-YYYY'), 900000, 75000, 'S', 'Administrativo', 2060, 216);
INSERT INTO EMPLEADO VALUES (756, 'Veronica', 'Soto', 'Alarcon', TO_DATE('01-04-2023','DD-MM-YYYY'), 880000, 70000, 'S', 'Vendedor', 2070, 222);
INSERT INTO EMPLEADO VALUES (759, 'Luis', 'Reyes', 'Fuentes', TO_DATE('18-04-2023','DD-MM-YYYY'), 560000, NULL, 'S', 'Vendedor', 2050, 228);
INSERT INTO EMPLEADO VALUES (762, 'Carlos', 'Navarro', 'Vega', TO_DATE('01-05-2023','DD-MM-YYYY'), 610000, NULL, 'S', 'Administrativo', 2050, 210);
INSERT INTO EMPLEADO VALUES (765, 'Javiera', 'Pino', 'Rojas', TO_DATE('18-05-2023','DD-MM-YYYY'), 650000, NULL, 'S', 'Vendedor', 2050, 210);
INSERT INTO EMPLEADO VALUES (768, 'Diego', 'Mella', 'Contreras', TO_DATE('20-05-2023','DD-MM-YYYY'), 620000, NULL, 'S', 'Vendedor', 2050, 216);
INSERT INTO EMPLEADO VALUES (771, 'Fernanda', 'Salas', 'Herrera', TO_DATE('18-05-2023','DD-MM-YYYY'), 570000, NULL, 'S', 'Vendedor', 2060, 216);
INSERT INTO EMPLEADO VALUES (774, 'Claudia', 'Fernandez', 'Lagos', TO_DATE('21-05-2023','DD-MM-YYYY'), 600000, NULL, 'S', 'Vendedor', 2080, 222);
INSERT INTO EMPLEADO VALUES (777, 'Tomas', 'Vidal', 'Espinoza', TO_DATE('01-06-2023','DD-MM-YYYY'), 530000, NULL, 'S', 'Vendedor', 2050, 222);

INSERT INTO VENTA (fecha_venta, total, id_medio, id_empleado)
VALUES (TO_DATE('12-05-2023','DD-MM-YYYY'), 225990, 12, 771);

INSERT INTO VENTA (fecha_venta, total, id_medio, id_empleado)
VALUES (TO_DATE('23-10-2023','DD-MM-YYYY'), 524990, 13, 777);

INSERT INTO VENTA (fecha_venta, total, id_medio, id_empleado)
VALUES (TO_DATE('17-02-2023','DD-MM-YYYY'), 466990, 11, 759);

-- PARTE 4 LAS CONSULTAS

-- INFORME
SELECT 
  id_empleado AS IDENTIFICADOR,
  nombre || ' ' || apellido_paterno || ' ' || apellido_materno AS "NOMBRE COMPLETO",
  sueldo AS SALARIO,
  bono AS BONIFICACION,
  (sueldo + bono) AS "SALARIO SIMULADO"
FROM EMPLEADO
WHERE activo = 'S' AND bono IS NOT NULL
ORDER BY "SALARIO SIMULADO" DESC, apellido_paterno DESC;

-- INFORME
SELECT 
  nombre || ' ' || apellido_paterno || ' ' || apellido_materno AS EMPLEADO,
  sueldo AS SUELDO,
  (sueldo * 0.08) AS "POSIBLE AUMENTO",
  (sueldo + (sueldo * 0.08)) AS "SUELDO SIMULADO"
FROM EMPLEADO
WHERE sueldo BETWEEN 550000 AND 800000
ORDER BY SUELDO ASC;
